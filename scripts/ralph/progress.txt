# Ralph Progress Log
Started: 2026-01-15
Feature: Astro Migration & OfficeRnD Flex 2 API Update
Parent Task: astro-migration-001

## Codebase Patterns
- **Astro Config**: Static output mode with Tailwind integration. Config at `astro.config.mjs`
- **TypeScript**: Using Astro's strict preset via `astro/tsconfigs/strict`. Path aliases configured with `@/*` -> `src/*`
- **Environment Variables**: Typed in `src/env.d.ts`, example values in `.env.example`
- **Tailwind**: Using v3.4 with `@astrojs/tailwind` integration. Custom fonts (Poppins, Crimson Pro) in extend block
- **Types**: All API and transformed data types in `src/lib/types.ts`. Use `Api*` prefix for raw API types, `Transformed*` for processed data
- **Privacy Field Inversion**: Flex 2 API uses `isVisible`/`showContactDetails`/`showSocialProfiles` (positive) but templates use `hide`/`hideContactDetails`/`hidePublicProfiles` (negative) - invert when transforming
- **API Client**: Use `getConfigFromEnv()` for config, then `fetchMembers(config)` and `fetchCompanies(config)` for data. Pagination handled automatically.
- **Data Transform**: Use `transformAllMembers(members)` and `transformAllCompanies(companies, members)` to process API data. Hidden profiles filtered automatically.
- **Slugify**: Use `slugify` package with `{ lower: true, remove: /[*+~.()/'"?!:@]/g }` to match existing URL format
- **Layouts**: Use `BaseLayout` from `@/layouts/BaseLayout.astro` with required `title` prop. Imports global styles automatically.

---

## 2026-01-15 - Initialize Astro project with TypeScript and Tailwind
Task ID: task-001
- Replaced Gridsome dependencies with Astro 5.x stack
- Configured TypeScript strict mode via Astro's recommended preset
- Set up @astrojs/tailwind integration
- Created typed environment variable definitions for OfficeRnD API
- Updated tailwind.config.js for Tailwind v3 with ESM syntax
- Created minimal index.astro page to verify build works
- **Files created:**
  - `astro.config.mjs` - Astro config with static output
  - `tsconfig.json` - TypeScript config extending Astro strict preset
  - `src/env.d.ts` - Environment variable type definitions
  - `src/pages/index.astro` - Minimal placeholder page
  - `.env.example` - Environment variable template
- **Files modified:**
  - `package.json` - Complete rewrite for Astro dependencies
  - `tailwind.config.js` - Updated to Tailwind v3 ESM format
  - `.gitignore` - Added Astro-specific entries

**Learnings for future iterations:**
- Legacy Gridsome files (.vue) in src/pages cause warnings but don't break Astro build
- Astro check reports hints for legacy JS files but these are non-blocking
- Node 20+ required for Astro 5.x

---

## 2026-01-15 - Create TypeScript interfaces for API and transformed data
Task ID: task-002
- Created comprehensive TypeScript interfaces for the OfficeRnD Flex 2 API
- Defined raw API interfaces: `ApiMember`, `ApiCompany`, `ApiPaginatedResponse<T>`
- Defined transformed data interfaces: `TransformedMember`, `TransformedCompany`
- Created utility types: `PortalPrivacy`, `SocialProfiles`, `ApiProperties`, `MemberStatus`, `CompanyStatus`
- Added collection entry types for future Astro content collections
- All interfaces use strict typing with no `any` types
- **Files created:**
  - `src/lib/types.ts` - All API and transformed data type definitions
  - `src/lib/AGENTS.md` - Guidelines for the lib directory

**Learnings for future iterations:**
- The Flex 2 API uses `socialProfiles` object instead of separate `twitterHandle`/`linkedin` fields, but legacy fields may still exist in responses
- Privacy fields in Flex 2 API use positive logic (`isVisible`, `showContactDetails`) while templates use negative logic (`hide`, `hideContactDetails`) - must invert when transforming
- The `properties` object is flexible with an index signature for custom fields, but `sdg` is a known array field
- Legacy `.vue` files trigger warnings about `@astrojs/vue` package but these are non-blocking since they will be migrated

---

## 2026-01-15 - Implement OfficeRnD Flex 2 API client
Task ID: task-003
- Implemented OAuth 2.0 client credentials flow with automatic token caching
- Created `fetchMembers()` function with automatic pagination via `$cursorNext`
- Created `fetchCompanies()` function with automatic pagination via `$cursorNext`
- Added `ApiError` custom error class with status code and endpoint info
- Added `getConfigFromEnv()` helper for reading environment variables
- Uses native `fetch` (no axios dependency)
- **Files created:**
  - `src/lib/api.ts` - OfficeRnD API client with authentication and data fetching
- **Files modified:**
  - `src/lib/AGENTS.md` - Added API client documentation and usage patterns

**Learnings for future iterations:**
- TypeScript has trouble inferring types in `do-while` loops with generics - use explicit type annotations inside loops
- Token caching is essential due to 5 req/min rate limit on token endpoint
- The Flex 2 API uses `$cursorNext` query parameter (with dollar sign) for pagination
- Response format is `{ results: T[], cursorNext?, cursorPrev?, rangeStart, rangeEnd }`
- Native `fetch` works well in Astro - no need for axios

---

## 2026-01-15 - Create data transformation layer
Task ID: task-004
- Created transformation layer to convert raw API data to template format
- Implemented `transformMember()` and `transformCompany()` functions
- Implemented helper functions:
  - `transformImageUrl()` - CloudFront to ImageKit URL conversion
  - `calculateImagePriority()` - Sort priority based on image presence
  - `generateSlug()` - URL-friendly slugs matching existing format
  - `isProfileHidden()` - Privacy check with API field inversion
  - `extractPrivacyOptions()` - Convert API privacy to template format
  - `extractSDGs()` - Extract SDG array from properties
  - `normalizeSocialProfiles()` - Merge new and legacy social fields
  - `fixUrl()` - Add protocol to URLs missing it
- Added batch functions `transformAllMembers()` and `transformAllCompanies()`
- Hidden profiles automatically filtered during transformation
- **Files created:**
  - `src/lib/transform.ts` - Complete data transformation layer
- **Files modified:**
  - `src/lib/AGENTS.md` - Added transformation documentation
  - `package.json` - Added slugify dependency

**Learnings for future iterations:**
- The `team` field on members may be undefined - must check before accessing
- Legacy fields (twitterHandle, linkedin) should still be supported for backward compatibility
- TypeScript warns about deprecated fields but this is intentional for legacy support
- Default image URL is from cdn.prod.website-files.com, not a local asset
- Companies use `startDate` for created date, while members use `createdAt`

---

## 2026-01-15 - Create BaseLayout Astro component
Task ID: task-005
- Created main layout component for all pages
- Implemented HTML5 document structure with Norwegian language (`lang="nb"`)
- Added meta tags: charset (UTF-8), viewport, favicon
- Added Google Fonts preconnect for Poppins and Crimson Pro (weights 300, 400, 700)
- Created global CSS file with Tailwind imports and animation classes from Default.vue
- Layout accepts required `title` prop via typed Props interface
- Background color: `rgb(225, 225, 219)`
- **Files created:**
  - `src/layouts/BaseLayout.astro` - Main layout component
  - `src/styles/global.css` - Tailwind imports and animation classes
  - `src/layouts/AGENTS.md` - Layout directory guidelines

**Learnings for future iterations:**
- Import global CSS in layout using `import '@/styles/global.css'` in the frontmatter
- Astro handles font preconnect in head section (no meta framework needed)
- Use `crossorigin` attribute (no value needed) on fonts.gstatic.com preconnect
- Animation classes from Vue transition system migrated to global CSS for potential future use

---

## 2026-01-15 - Create ProfileCard Astro component
Task ID: task-006
- Created reusable ProfileCard component for member/team profile display
- Props: `slug`, `name`, `image`, `teamName?`, `basePath?`
- Image uses native `loading="lazy"` for performance
- Members (have teamName) use `object-cover`, teams use `object-contain`
- Text truncation via scoped `.cut-text` class (ellipsis)
- Card dimensions: 320px width, 320px image height
- Accessibility: aria-labels on links for screen readers
- **Files created:**
  - `src/components/ProfileCard.astro` - Reusable profile card component
  - `src/components/AGENTS.md` - Components directory guidelines

**Learnings for future iterations:**
- Use `class:list` directive for conditional classes in Astro
- Scoped styles in Astro use `<style>` without special attributes (unlike Vue's `scoped`)
- The `basePath` prop pattern allows reuse for both members (root) and teams (/teams prefix)
- Original Vue component had inverted logic: teamName presence = member, absence = team

---

## 2026-01-15 - Create utility components (TitleSection, PageSwitch)
Task ID: task-007
- Created TitleSection.astro for consistent page header styling
- Created PageSwitch.astro for members/teams navigation toggle
- TitleSection accepts `title` prop and renders h1 with font-sans, text-4xl, font-bold, leading-snug
- PageSwitch displays two tab-like links (Medlemmer, Virksomheter) with active state highlighting
- PageSwitch uses `Astro.url.pathname` to determine current page
- Added `aria-current="page"` for accessibility on active tab
- Improved from original Vue component: now shows both options as tabs instead of single link
- **Files created:**
  - `src/components/TitleSection.astro` - Page title component
  - `src/components/PageSwitch.astro` - Navigation toggle component
- **Files modified:**
  - `src/components/AGENTS.md` - Added documentation for both components

**Learnings for future iterations:**
- Use `Astro.url.pathname` to access the current URL path in Astro components
- Check for both `/teams` and `/teams/` when comparing paths (trailing slash handling)
- `aria-current="page"` is the proper accessibility attribute for indicating current page in navigation
- The original PageSwitch was a single link; enhanced version shows both options as tabs with highlighting
- `class:list` directive works well for conditional class toggling based on state

---

## 2026-01-15 - Create SDG goals data file
Task ID: task-008
- Created data directory `src/data/` for static data files
- Implemented SDGGoal interface with id, name, and color properties
- Exported readonly array of all 17 UN SDGs with Norwegian names from src/filter.js
- Added official UN SDG colors for each goal
- Created helper functions: `getSDGById()`, `getSDGByName()`, `getSDGsByNames()`
- Used `as const` assertion for immutability
- **Files created:**
  - `src/data/sdg-goals.ts` - SDG goals data with TypeScript types
  - `src/data/AGENTS.md` - Data directory guidelines

**Learnings for future iterations:**
- SDG goal names must match exactly with values stored in member/company `properties.sdg` arrays
- The `as const` pattern ensures array is readonly and provides better type inference
- Helper functions like `getSDGsByNames()` are useful for converting string arrays to typed objects
- Official UN SDG colors can be used for visual indicators in filtering UI

---

## 2026-01-15 - Build members listing page
Task ID: task-009
- Built complete members listing page with build-time data fetching
- Implemented client-side search filtering by name and team name
- Members sorted by priority ASC, then created DESC (images first)
- Responsive grid using CSS Grid with `auto-fill, minmax(320px, 1fr)`
- Renders ProfileCard components for each member
- Uses BaseLayout, TitleSection, and PageSwitch components
- Search uses data attributes for case-insensitive filtering
- **Files modified:**
  - `src/pages/index.astro` - Complete rewrite as members listing page

**Learnings for future iterations:**
- The `TransformedMember.created` field is optional (`string | undefined`) - handle with ternary when sorting
- Client-side search in Astro uses `<script>` block with vanilla JS (no framework needed)
- Use `data-*` attributes to pass lowercase values for case-insensitive filtering
- CSS Grid with `auto-fill` and `justify-items: center` creates responsive card layouts
- Astro inline scripts run after DOM is ready - no need for DOMContentLoaded listener

---

## 2026-01-15 - Build teams listing page
Task ID: task-010
- Built teams (companies) listing page following same structure as members page
- Fetches both companies and members at build time (members needed for transformAllCompanies)
- Teams sorted by priority ASC, then created DESC (images first)
- Client-side search filtering by team name only
- Uses ProfileCard with `basePath="/teams"` for proper routing
- Responsive grid using same CSS Grid layout as members page
- **Files created:**
  - `src/pages/teams.astro` - Teams listing page

**Learnings for future iterations:**
- `transformAllCompanies(companies, members)` requires both datasets - use `Promise.all()` for parallel fetching
- Teams page search is simpler than members (only searches by team name, not member names)
- The `basePath` prop on ProfileCard routes to `/teams/[slug]` instead of `/[slug]`
- Grid card class naming follows pattern: `member-card` for members, `team-card` for teams
- Companies use `TransformedCompany.created` which maps from `company.startDate`

---

## 2026-01-15 - Create SDG filter component
Task ID: task-011
- Created interactive SDGFilter.astro component with all 17 UN SDGs as toggleable chips
- Used official UN SDG colors with CSS custom property `--sdg-color` for dynamic styling
- Implemented client-side filtering logic with Set-based state management
- Added clear filter button with disabled state when no filters selected
- Dispatches custom `sdg-filter-change` event on document with selectedSDGs array
- Mobile-responsive: hides SDG names on small screens, shows only numbers
- Full accessibility support with `aria-pressed` and `aria-label` attributes
- **Files created:**
  - `src/components/SDGFilter.astro` - Interactive SDG filter component
- **Files modified:**
  - `src/components/AGENTS.md` - Added SDGFilter documentation with integration patterns

**Learnings for future iterations:**
- Use CSS custom properties (`--sdg-color`) with inline `style` attribute for dynamic per-element colors
- `color-mix()` CSS function allows clean hover states without JavaScript color manipulation
- Custom events with `bubbles: true` allow flexible listener placement (on document or parent elements)
- The `sdg-filter-change` event detail contains Norwegian SDG names matching `properties.sdg` values from API
- For filtering: store SDG names in `data-sdgs` attribute as comma-separated string, then split and check intersection
- Mobile-first responsive: use `@media (max-width: 640px)` to hide verbose labels, show only numbers

---
