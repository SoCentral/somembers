---
/**
 * Teams Listing Page
 *
 * Displays all non-hidden teams (companies) in a responsive grid.
 * Features:
 * - Build-time data fetching from OfficeRnD API
 * - Client-side search filtering by team name
 * - Sorted by priority ASC, then created DESC
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import TitleSection from '@/components/TitleSection.astro';
import PageSwitch from '@/components/PageSwitch.astro';
import ProfileCard from '@/components/ProfileCard.astro';
import SDGFilter from '@/components/SDGFilter.astro';
import { getConfigFromEnv, fetchCompanies, fetchMembers } from '@/lib/api';
import { transformAllCompanies } from '@/lib/transform';
import type { TransformedCompany } from '@/lib/types';

// Fetch and transform companies at build time
// Need both companies and members for transformAllCompanies
const config = getConfigFromEnv();
const [rawCompanies, rawMembers] = await Promise.all([
  fetchCompanies(config),
  fetchMembers(config),
]);
const teams = transformAllCompanies(rawCompanies, rawMembers);

// Sort by priority ASC, then by created DESC
teams.sort((a: TransformedCompany, b: TransformedCompany) => {
  // First sort by priority (lower number = higher priority)
  if (a.priority !== b.priority) {
    return a.priority - b.priority;
  }
  // Then sort by created date (newer first)
  // Handle undefined created dates by treating them as oldest
  const dateA = a.created ? new Date(a.created).getTime() : 0;
  const dateB = b.created ? new Date(b.created).getTime() : 0;
  return dateB - dateA;
});
---

<BaseLayout title="Virksomheter - SoCentral Members">
  <section class="container w-full mt-20 mb-10 lg:my-10 lg:w-3/5 lg:mx-auto lg:text-center">
    <TitleSection title="Våre virksomheter" />
    <PageSwitch />
    <input
      id="search-input"
      class="block lg:mx-auto font-sans mb-4 w-full md:w-64 border border-gray-500 rounded py-2 px-2 text-gray-800 focus:outline-none focus:border-green-900"
      type="text"
      placeholder="Søk"
      aria-label="Søk i oversikten over virksomheter"
    />
    <SDGFilter />
  </section>

  <section id="empty-state" class="hidden text-center py-12">
    <p class="text-gray-600 font-sans text-lg">Ingen virksomheter funnet med valgte filtre.</p>
  </section>

  <section id="teams-grid" class="cards">
    {teams.map((team: TransformedCompany) => (
      <div
        class="team-card"
        data-name={team.name.toLowerCase()}
        data-sdgs={team.sdgs.join(',')}
      >
        <ProfileCard
          slug={team.slug}
          name={team.name}
          image={team.image}
          basePath="/teams"
        />
      </div>
    ))}
  </section>
</BaseLayout>

<style>
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    justify-items: center;
    padding: 0 1rem 2rem;
  }

  .team-card {
    transition: opacity 0.3s ease;
  }

  .team-card.hidden {
    display: none;
  }
</style>

<script>
  // Client-side search and SDG filter functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const teamCards = document.querySelectorAll('.team-card');
  const teamsGrid = document.getElementById('teams-grid') as HTMLElement;
  const emptyState = document.getElementById('empty-state') as HTMLElement;

  // Track current SDG filter state
  let selectedSDGs: string[] = [];

  function filterTeams(): void {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    teamCards.forEach((card) => {
      const name = card.getAttribute('data-name') ?? '';
      const cardSDGs = card.getAttribute('data-sdgs')?.split(',').filter(Boolean) ?? [];

      // Search filter: match name
      const matchesSearch = searchTerm === '' || name.includes(searchTerm);

      // SDG filter: match ANY selected SDG (OR logic), or show all if no SDGs selected
      const matchesSDG = selectedSDGs.length === 0 ||
        selectedSDGs.some((sdg: string) => cardSDGs.includes(sdg));

      // Both filters must match
      if (matchesSearch && matchesSDG) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // Show/hide empty state
    if (visibleCount === 0) {
      teamsGrid.classList.add('hidden');
      emptyState.classList.remove('hidden');
    } else {
      teamsGrid.classList.remove('hidden');
      emptyState.classList.add('hidden');
    }
  }

  // Listen for search input
  searchInput.addEventListener('input', filterTeams);

  // Listen for SDG filter changes
  document.addEventListener('sdg-filter-change', (event) => {
    const customEvent = event as CustomEvent<{ selectedSDGs: string[] }>;
    selectedSDGs = customEvent.detail.selectedSDGs;
    filterTeams();
  });
</script>
